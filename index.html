<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Televerse Character Selection</title>

        <script src="https://telegram.org/js/telegram-web-app.js"></script>
        
        <!-- Babylon.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://assets.babylonjs.com/generated/Assets.js"></script>
        <script src="https://cdn.babylonjs.com/recast.js"></script>
        <script src="https://cdn.babylonjs.com/ammo.js"></script>
        <script src="https://cdn.babylonjs.com/havok/HavokPhysics_umd.js"></script>
        <script src="https://cdn.babylonjs.com/cannon.js"></script>
        <script src="https://cdn.babylonjs.com/Oimo.js"></script>
        <script src="https://cdn.babylonjs.com/earcut.min.js"></script>
        <script src="https://cdn.babylonjs.com/babylon.js"></script>
        <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://cdn.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://cdn.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://cdn.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://cdn.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

        <style>
            html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
            
            #canvasZone {
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
<body>
    <div id="canvasZone"><canvas id="renderCanvas"></canvas></div>
    <script>
        var canvas = document.getElementById("renderCanvas");

        var startRenderLoop = function (engine, canvas) {
            engine.runRenderLoop(function () {
                if (sceneToRender && sceneToRender.activeCamera) {
                    sceneToRender.render();
                }
            });
        }

        var webApp = null;
        var engine = null;
        var scene = null;
        var sceneToRender = null;
        var createDefaultEngine = function() { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true,  disableWebGL2Support: false}); };
        
        <!-- Babylon.js block start -->
        var createScene = function () {
            // This creates a basic Babylon Scene object (non-mesh)
            var scene = new BABYLON.Scene(engine);
        
            var camera = new BABYLON.ArcRotateCamera("camera", BABYLON.Tools.ToRadians(-90), BABYLON.Tools.ToRadians(65), 5, new BABYLON.Vector3(0, 1, 0), scene);
        
            // This attaches the camera to the canvas
            camera.attachControl(canvas, true);
            camera.panningAxis = new BABYLON.Vector3.Zero;
            camera.upperBetaLimit = Math.PI/2;
            camera.lowerRadiusLimit = 2;
            camera.upperRadiusLimit = 10;
        
            // This creates a light, aiming 0,1,0 - to the sky (non-mesh)
            var light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
        
            // Default intensity is 1. Let's dim the light a small amount
            light.intensity = 0.8;
        
            // Our built-in 'ground' shape.
            var ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 6, height: 6}, scene);
            const groundMaterial = new BABYLON.StandardMaterial("Ground Material", scene);
            let groundTexture = new BABYLON.Texture(Assets.textures.checkerboard_basecolor_png.rootUrl, scene);
            groundMaterial.diffuseTexture = groundTexture;
            ground.material = groundMaterial;
        
            const mainFolder = "https://mrtrickster.github.io/televerse.store/";
            const modelsFolder = "https://mrtrickster.github.io/televerse.store/models/";
        
            var charactersList;
            var counter = 0;
            var character;
            
            loadCharactersList();
            createGUI();
        
            function loadCharactersList() {
                fetch(mainFolder + 'maleCharacters.json').then(response => response.json()).then(data => {
                    // 'data' is the parsed JSON object
                    console.log(data);
                    charactersList = findNodeByName(data, "characters");
                    removeCharacter();
                    loadCharacter();
                }).catch(error => {
                    console.error('Error fetching JSON:', error);
                });
            }
        
            function removeCharacter() {
                if (character) {
                    // Remove the mesh from the scene
                    character.dispose();
                    // Optionally, set the reference to null or perform any additional cleanup
                    character = null;
                }
            }
        
            function loadCharacter() {    
                BABYLON.SceneLoader.ImportMesh("", modelsFolder, charactersList[counter] + ".glb", scene, function(newMeshes){
                    newMeshes[0].scaling = new BABYLON.Vector3(0.01, 0.01, 0.01);
                    character = newMeshes[0];
                });
            }
            
            function findNodeByName(jsonObj, nodeName) {
                // Base case: if the current node is an object and has the desired name, return it
                if (typeof jsonObj === 'object' && jsonObj !== null) {
                    if (jsonObj.hasOwnProperty(nodeName)) {
                        return jsonObj[nodeName];
                    }
                }
                // Recursive case: traverse all properties of the current node
                for (var key in jsonObj) {
                    if (jsonObj.hasOwnProperty(key)) {
                        var foundNode = findNodeByName(jsonObj[key], nodeName);
                        if (foundNode !== undefined) {
                            return foundNode;
                        }
                    }
                }
                // Node with the desired name not found
                return undefined;
            }
        
            var debugText;
        
            function createGUI() {
                // GUI
                var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
                
                debugText = new BABYLON.GUI.TextBlock("debugText", "Start\n");
                debugText.color = "white";
                debugText.fontSize = "10px";
                debugText.textHorizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                debugText.textVerticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;
                advancedTexture.addControl(debugText);
        
                var prevButton = BABYLON.GUI.Button.CreateSimpleButton("prevButton", "<");
                prevButton.width = "60px";
                prevButton.height = "60px";
                prevButton.left = "-120px";
                prevButton.color = "white";
                prevButton.cornerRadius = 30;
                prevButton.background = "blue";
                prevButton.onPointerUpObservable.add(function() {
                    if (counter > 0) counter--;
                    else counter = charactersList.length - 1;
                    removeCharacter();
                    loadCharacter();
                });
                advancedTexture.addControl(prevButton);
        
                var nextButton = BABYLON.GUI.Button.CreateSimpleButton("nextButton", ">");
                nextButton.width = "60px";
                nextButton.height = "60px";
                nextButton.left = "120px";
                nextButton.color = "white";
                nextButton.cornerRadius = 30;
                nextButton.background = "blue";
                nextButton.onPointerUpObservable.add(function() {
                    if (counter < charactersList.length - 1) counter++;
                    else counter = 0;
                    removeCharacter();
                    loadCharacter();
                });
                advancedTexture.addControl(nextButton);
                
                var button1 = BABYLON.GUI.Button.CreateSimpleButton("but1", "Select Me!");
                button1.width = "150px"
                button1.height = "40px";
                button1.top = "200px";
                button1.color = "white";
                button1.cornerRadius = 20;
                button1.background = "green";
                button1.onPointerUpObservable.add(function() {
                    log("you did it!");
                });
                advancedTexture.addControl(button1);
            }
        
            function log(message) {
                debugText.text += message + "\n";
            }
        
            return scene;
        };
        <!-- Babylon.js block end -->
    
        window.initFunction = async function() {
            webApp = window.Telegram.WebApp;
            if (webApp != null) alert("webapp set!");
            
            var asyncEngineCreation = async function() {
                try {
                    return createDefaultEngine();
                } catch(e) {
                    console.log("the available createEngine function failed. Creating the default engine instead");
                    return createDefaultEngine();
                }
            }
            window.engine = await asyncEngineCreation();
            if (!engine) throw 'engine should not be null.';
            startRenderLoop(engine, canvas);
            window.scene = createScene();
        };
        initFunction().then(() => {sceneToRender = scene});

        // Resize
        window.addEventListener("resize", function () {engine.resize();});
    </script>
</body>
</html>
